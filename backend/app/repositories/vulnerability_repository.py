"""
Repository for Vulnerability database operations.
Implements data access layer following Repository pattern.
"""

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import List, Optional

from ..database import Vulnerability
from scanners.base import VulnerabilityResult


class VulnerabilityRepository:
    """Repository for Vulnerability entity operations."""
    
    def __init__(self, session: AsyncSession):
        """
        Initialize repository with database session.
        
        Args:
            session: Async database session
        """
        self.session = session
    
    async def create_from_result(self, scan_id: int, vuln_result: VulnerabilityResult) -> Vulnerability:
        """
        Create a vulnerability record from a VulnerabilityResult.
        
        Args:
            scan_id: Associated scan ID
            vuln_result: VulnerabilityResult from scanner
            
        Returns:
            Created Vulnerability object
        """
        vuln = Vulnerability(
            scan_id=scan_id,
            name=vuln_result.name,
            severity=vuln_result.severity,
            description=vuln_result.description,
            url=vuln_result.url,
            parameter=vuln_result.parameter,
            payload=vuln_result.payload,
            attack=vuln_result.attack,
            cause=vuln_result.cause,
            fix=vuln_result.fix,
            why=vuln_result.why,
            evidence=vuln_result.evidence
        )
        self.session.add(vuln)
        await self.session.flush()
        await self.session.refresh(vuln)
        return vuln
    
    async def create_batch(self, scan_id: int, vuln_results: List[VulnerabilityResult]) -> List[Vulnerability]:
        """
        Create multiple vulnerability records from VulnerabilityResult list.
        Optimized batch creation with single flush operation.
        
        Args:
            scan_id: Associated scan ID
            vuln_results: List of VulnerabilityResult objects
            
        Returns:
            List of created Vulnerability objects
        """
        if not vuln_results:
            return []
        
        vulns = []
        for vuln_result in vuln_results:
            vuln = Vulnerability(
                scan_id=scan_id,
                name=vuln_result.name,
                severity=vuln_result.severity,
                description=vuln_result.description,
                url=vuln_result.url,
                parameter=vuln_result.parameter,
                payload=vuln_result.payload,
                attack=vuln_result.attack,
                cause=vuln_result.cause,
                fix=vuln_result.fix,
                why=vuln_result.why,
                evidence=vuln_result.evidence
            )
            self.session.add(vuln)
            vulns.append(vuln)
        
        # Single flush for all vulnerabilities (more efficient than per-item flush)
        await self.session.flush()
        
        # Refresh all at once (optional - only needed if you need IDs immediately)
        # for vuln in vulns:
        #     await self.session.refresh(vuln)
        
        return vulns
    
    async def get_by_scan_id(self, scan_id: int) -> List[Vulnerability]:
        """
        Get all vulnerabilities for a scan.
        
        Args:
            scan_id: Scan ID
            
        Returns:
            List of Vulnerability objects
        """
        query = select(Vulnerability).where(Vulnerability.scan_id == scan_id)
        result = await self.session.execute(query)
        return list(result.scalars().all())
    
    async def get_by_id(self, vuln_id: int) -> Optional[Vulnerability]:
        """
        Get vulnerability by ID.
        
        Args:
            vuln_id: Vulnerability ID
            
        Returns:
            Vulnerability object or None if not found
        """
        query = select(Vulnerability).where(Vulnerability.id == vuln_id)
        result = await self.session.execute(query)
        return result.scalar_one_or_none()

